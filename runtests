#!/bin/bash

function install_test_deps {
    pip install pytest requests
}

function start_test_server {
    echo "Starting test server. Log: tests/server.log"
    rm -f tests/server.log
    PYTHONPATH=. python tests/helpers.py start_test_server >tests/server.log 2>&1 &
}

function run_tests {
    install_test_deps
    start_test_server
    PYTHONPATH=. py.test -vs tests/ $@
    exit_code=$?
    stop_test_server
    exit $exit_code
}

function stop_test_server {
	echo "Stop test server..."
    ps ax | grep start_test_server | grep -v grep | cut -d ' ' -f 1 | xargs kill
}

if [ -z "$1" ]; then
	run_tests $@
else
	$@ 
fi
